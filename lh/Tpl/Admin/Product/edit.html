{// 加载头部公共文件 }
<include file="Public:header" />
<div class="sysM">
    <h3><if condition="$productInfo['id']">编辑产品<else/>新增产品</if>>> 【<a href="{:U('Product/index')}">产品列表</a>】<br /></h3>
    <form action="__SELF__" method="post">
        <ul class="addad">
            <li>
                <span class="addadtit">产品名称：</span>
                <input type="text" name="name" value="{$productInfo.name}"/>
            </li>
            <li>
                <span class="addadtit">产品类型：</span>
                <select name="type"  hidefocus>
                    <volist name="dicts" id="dt">
                        <if condition="$dt['id'] eq $productInfo['type']">
                            <option value="{$dt.id}" selected="selected">{$dt.val}</option>
                            <else/>
                            <option value="{$dt.id}" >{$dt.val}</option>
                        </if>
                    </volist>
                </select>
            </li>
            <li>
                <span class="addadtit">图片：</span>
                <input type="text" id="jupload" name="titleImg" value="{$productInfo.titleImg}" />
                <input type="button" class="reset" id="picBtn" value="上传" />
            </li>
            <li>
                <span class="addadtit">产品说明：</span>
                <input type="button" class="reset" id="addAttribute" value="添加" />
            </li>
        </ul>
        <div id="attrTabs">
            <ul>
                <volist name="productInfo.attributes" id="attr">
                    <li>
                        <a href="#tabs-{$attr.id}" data-attrid="{$attr.id}">
                            <strong class="attrName">{$attr.attrName}</strong>
                            <span class="action">
                                <input type="text" name="attrName[{$attr.id}][]" value="{$attr.attrName}"/>
                                <button class="edit">修改</button>
                                <button class="delete">删除</button>
                            </span>
                        </a>
                    </li>
                </volist>
            </ul>
            <volist name="productInfo.attributes" id="attr">
                <div id="tabs-{$attr.id}">
                    <textarea id="editor_id_{$attr.id}" class="attr_editor" name="attrValue[{$attr.id}][]" style="width:670px;height:300px;">{$attr.attrValue}</textarea>
                </div>
            </volist>
        </div>
        <ul class="addad">
            <li>
                <input type="hidden" name="id" value="{$productInfo.id}" />
                <input class="submit" name="setSubmit" type="submit" value="保 存" />
                <input class="reset" name="backBtn" type="reset" value="取 消" onclick="window.history.back(-1);"/>
            </li>
        </ul>
    </form>
</div>
<script type="text/javascript">
    var editor;
    var options = {
        uploadJsonPath : "{:U('Kindeditorupload/imageupload')}",
        fileJsonPath : "{:U('Kindeditorupload/filemanager')}"
    };
    KindEditor.ready(function(K) {


        jq(".attr_editor").each(function(i,item){
            K.create('#' + jq(this).attr('id'),options);
        });

    });

    jq(document).ready(function() {
        var tabs = jq( "#attrTabs" ).tabs({
            event: "mouseover"
        });

        tabs.delegate('ul li', 'click', function(){
            var tabHead = jq(this);
            tabHead.find('.attrName').hide();
            tabHead.find('.action').show();
            tabHead.delegate('.action .edit', 'click', function(e){
                e.stopPropagation();
                e.preventDefault();
                tabHead.find('.action').hide();
                tabHead.find('.attrName').text(tabHead.find('.action input').val());
                tabHead.find('.attrName').show();
            });

            tabs.delegate( ".action .delete", "click", function(e) {
                e.stopPropagation();
                e.preventDefault();
                var panelId = jq( this ).closest( "li" ).remove().attr( "aria-controls" );
                console.log(panelId);
                $( "#" + panelId ).remove();
                tabs.tabs( "refresh" );
            });
        });

        jq("#attrTabs ul li").click(function(){
            var tabHead = jq(this);
            tabHead.find('.attrName').hide();
            tabHead.find('.action').show();
            tabHead.find('.action .edit').click(function(e){
                e.stopPropagation();
                e.preventDefault();
                tabHead.find('.action').hide();
                tabHead.find('.attrName').text(tabHead.find('.action input').val());
                tabHead.find('.attrName').show();
            });
            tabs.delegate( ".action .delete", "click", function(e) {
                e.stopPropagation();
                e.preventDefault();
                var panelId = jq( this ).closest( "li" ).remove().attr( "aria-controls" );
                console.log(panelId);
                $( "#" + panelId ).remove();
                tabs.tabs("option", "active", tabs.find('.ui-tabs-panel').length - 1);
                tabs.tabs( "refresh" );
            });

        });

        var tabNavHtml =
                '<li>' +
                    '<a href="#{href}">' +
                        '<strong class="attrName">新的属性</strong>' +
                        '<span class="action">' +
                            '<input type="text" name="attrName[]" value="新的属性"/>' +
                            '<button class="edit">修改</button>' +
                            '<button class="delete">删除</button>' +
                        '</span>' +
                    '</a>' +
                '</li>';

        var tabContentHtml = '<div id="tabs-#{id}"><textarea id="editor_id_#{id}" class="attr_editor" name="attrValue[]" style="width:670px;height:300px;"></textarea></div>';

        jq("#addAttribute").click(function(){
            var maxId = 0;
            tabs.find('li a').each(function(i, item){
                var attrid = parseInt(jq(this).attr('data-attrid'));
                if(attrid > maxId) {
                    maxId = attrid;
                }
                maxId ++;
            });
            var li = jq(tabNavHtml.replace(/#\{href\}/g, "#tabs-" + maxId));
            tabs.find( ".ui-tabs-nav" ).append( li );
            tabs.append(jq(tabContentHtml.replace(/#\{id\}/g, maxId)));
            KindEditor.create('#editor_id_' + maxId, options);
            tabs.tabs( "refresh" );
        });

        new AjaxUpload('#picBtn', {
            action :'{:U('Upload/upload')}',//请求目标
                name:'upfile',//文件参数名
                multiple:false,//可以多选文件
                onComplete:function(file, response) {
                        var response = eval('('+response+')');
                        if(response.msg){
                            alert(response.msg);
                        }else{
                            jq('#jupload').val(response.file);
                        }
                    }
    });

    });
</script>
<!-- 主页面结束 -->
{// 加载尾部公共文件 }
<include file="Public:mainfooter" />